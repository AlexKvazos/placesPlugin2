<!DOCTYPE html>
<html>
<head>
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <meta charset="utf-8">
    <link href="./css/general.css" rel="stylesheet">
    <script src="../../../scripts/buildfire.js"></script>
</head>
<body>
<div id="map"></div>
<script>
    let map,
        usa = {lat: 37.09024, lng: -95.712891},
        zoomLevel = {city: 14, country: 3},
        defaultLocation = usa,
        lastKnownLocation = defaultLocation;

    let filter = () => {console.error('filter goes here');};
    let changeView = () => {console.error('changeView');};
    let centerMap = () => {map.setCenter(lastKnownLocation);};

    function createControl(controlDiv, buttons){
        let container = document.createElement('div');
        container.className = 'buttonContainer';
        controlDiv.appendChild(container);

        buttons.forEach((button) =>{
            let controlButton = document.createElement('div');
            controlButton.style.display = 'inline-block';
            controlButton.style.padding = button.padding;
            controlButton.innerHTML = `<img id="${button.name}" src="./images/${button.name}.svg"></img>`;
            if(button.action)
                controlButton.onclick = button.action;
            container.appendChild(controlButton);
        });

        return container;
    }

    function CenterControl(controlDiv) {
        createControl(controlDiv, [{name:'center', action: centerMap, padding: '8px'}]);
    }

    function FilterControl (controlDiv){
        createControl(controlDiv, [{name:'list', action: changeView, padding: '12px'},
            {name:'filter', action: filter, padding: '12px'}]);
    }

    function createMap(latitude, longitude){
        let locationBottomLeft = google.maps.ControlPosition.BOTTOM_LEFT,
            locationBottomRight = google.maps.ControlPosition.BOTTOM_RIGHT,
            mapTypeId = google.maps.MapTypeId.ROADMAP,
            zoomPosition = google.maps.ControlPosition.RIGHT_TOP;


        let options = {
            streetViewControl: false,
            mapTypeControl: false,
            fullscreenControl: false,
            zoom: zoomLevel.country,
            center: defaultLocation,
            mapTypeId: mapTypeId,
            zoomControlOptions: {
                position: zoomPosition
            }
        };

        map = new google.maps.Map(document.getElementById('map'), options);

        let centerControlDiv = document.createElement('div'),
            filterMapDiv = document.createElement('div');

        new CenterControl(centerControlDiv);
        new FilterControl(filterMapDiv);

        centerControlDiv.index = 1;

        map.controls[locationBottomLeft].push(centerControlDiv);
        map.controls[locationBottomRight].push(filterMapDiv);
    }

    function initMap() {
        //Create the map first (Don't wait for location)
        createMap(defaultLocation.lat, defaultLocation.lng);

        //Center map once location is obtained
        buildfire.geo.getCurrentPosition({}, (err, position) => {
            if(!err && position && position.coords){
                lastKnownLocation = {lat: position.coords.latitude, lng: position.coords.longitude};

                map.setCenter(lastKnownLocation);
                map.setZoom(zoomLevel.city);
            }
        });
    }
</script>
<!-- ?libraries=places&sensor=true& -->
<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyC4Dw4EzKeyVBXWBsbO9-UgyEARL6WLrlU&callback=initMap"
        async defer></script>
</body>
</html>